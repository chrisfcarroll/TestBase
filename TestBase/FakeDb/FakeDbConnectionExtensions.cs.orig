<<<<<<< HEAD
﻿using System.Collections.Generic;
using System.Data.Common;
using System.Reflection;
=======
﻿using System;
using System.Collections.Generic;
>>>>>>> 0a105a784a5b90c0c468ab057555278cab8427c3

namespace TestBase.FakeDb
{
    public static class FakeDbConnectionExtensions
    {
        /// <summary>
<<<<<<< HEAD
        /// Sets up the Fake DbConnection to return a FakeDbCommand which is itself set up to return the <see cref="scalar"/> when 
        /// <see cref="DbCommand.ExecuteScalar"/> is called on it.
        /// 
        /// The FakeDbCommands are (in the current version) queued and must be invoked in the order they were setup.
        /// </summary>
        /// <returns>Itself, for chaining</returns>
=======
        /// Queue a command to the fake database connection which when invoked 
        /// with ExecuteQuery() will return a 1x1 result set containing the given scalar value
        /// </summary>
>>>>>>> 0a105a784a5b90c0c468ab057555278cab8427c3
        public static FakeDbConnection SetUpForExecuteScalar(this FakeDbConnection fakeDbConnection, object scalar)
        {
            fakeDbConnection.QueueCommand(FakeDbCommand.forExecuteScalarResult(scalar));
            return fakeDbConnection;
        }

        /// <summary>
<<<<<<< HEAD
        /// Sets up the Fake DbConnection to return a FakeDbCommand which is itself set up to return <see cref="rowsAffected"/> when 
        /// <see cref="DbCommand.ExecuteNonQuery"/> is called on it.
        /// 
        /// The FakeDbCommands are (in the current version) queued and must be invoked in the order they were setup.
        /// </summary>
        /// <returns>Itself, for chaining</returns>
=======
        /// Queue a command to the fake database connection which when invoked with
        /// ExecuteNonQuery will return the setup rowsAffected
        /// </summary>
        /// <param name="timesConsecutively">If a command is to be called repeated, use this to set up for multiple consecutive calls</param>
>>>>>>> 0a105a784a5b90c0c468ab057555278cab8427c3
        public static FakeDbConnection SetUpForExecuteNonQuery(this FakeDbConnection fakeDbConnection, int rowsAffected, int timesConsecutively = 1)
        {
            for (int i = 1; i <= timesConsecutively; i++)
            {
                fakeDbConnection.QueueCommand(FakeDbCommand.ForExecuteNonQuery(rowsAffected));
            }
            return fakeDbConnection;
        }

        /// <summary>
<<<<<<< HEAD
        /// Sets up the Fake DbConnection to return a FakeDbCommand which is itself set up to return <see cref="dataToReturn"/> when 
        /// either the protected <see cref="DbCommand.ExecuteDbDataReader"/> or the public 
        /// <see cref="DbCommand.ExecuteReader()"/> is called on it.
        /// 
        /// This overload will return a result set with 1 column and 1 row.
        /// 
        /// The FakeDbCommands are (in the current version) queued and must be invoked in the order they were setup.
        /// </summary>
        /// <param name="dataToReturn">A scalar data item</param>
        /// <returns>Itself, for chaining</returns>
=======
        /// Queue a command to the fake database connection which when invoked with
        /// ExecuteQuery will return a 1x1 result set containing the dataToReturn.
        /// </summary>
>>>>>>> 0a105a784a5b90c0c468ab057555278cab8427c3
        public static FakeDbConnection SetUpForQueryScalar<T>(this FakeDbConnection fakeDbConnection, T dataToReturn)
        {
            fakeDbConnection.SetUpForQuery(new[] {dataToReturn});
            return fakeDbConnection;
        }

        /// <summary>
<<<<<<< HEAD
        /// Sets up the Fake DbConnection to return a FakeDbCommand which is itself set up to return <see cref="dataToReturn"/> when 
        /// either the protected <see cref="DbCommand.ExecuteDbDataReader"/> or the public 
        /// <see cref="DbCommand.ExecuteReader()"/> is called on it.
        /// 
        /// This overload will return a result set with just 1 column and <see cref="dataToReturn"/>.Count() rows.
        /// 
        /// The FakeDbCommands are (in the current version) queued and must be invoked in the order they were setup.
        /// </summary>
        /// <param name="dataToReturn">A scalar data item</param>
        /// <returns>Itself, for chaining</returns>
=======
        /// Queue a command to the fake database connection which when invoked with
        /// ExecuteQuery will return a result set with rows containing the rows of dataToReturn.
        /// The returned rows will contain one column for each public property of the dataToReturn.
        /// Execution will fail if T does not have a public constructor with either no parameters or else 
        /// one correspondingly-named parameter for each public property
        /// 
        /// Use this overload to setup database queries with columns which exactly correspond to some class defined in your project
        /// 
        /// Example
        /// <code>
        /// fakeDbConnection.SetUpForQuery&lt;KeyValuePair&lt;int,string&gt&gt;(new []{new KeyValuePair&lt;int,string&gt(1,"1")});
        /// </code>
        /// will return a single row with two un-named columns, the first integer, the second string.
        /// When used with Dapper, will simply rehydrate the given dataToReturn
        /// </summary>
        /// <param name="dataToReturn">The given object will be reflected for its public properties.</param>
>>>>>>> 0a105a784a5b90c0c468ab057555278cab8427c3
        public static FakeDbConnection SetUpForQuery<T>(this FakeDbConnection fakeDbConnection, IEnumerable<T> dataToReturn)
        {
            fakeDbConnection.QueueCommand( FakeDbCommand.ForExecuteSingleColumnQuery(dataToReturn) );
            return fakeDbConnection;
        }

        /// <summary>
<<<<<<< HEAD
        /// Sets up the Fake DbConnection to return a FakeDbCommand which is itself set up to return <see cref="dataToReturn"/> when 
        /// either the protected <see cref="DbCommand.ExecuteDbDataReader"/> or the public 
        /// <see cref="DbCommand.ExecuteReader()"/> is called on it.
        /// 
        /// This overload will return a result set with 1 column per string in <see cref="propertyNames"/> 
        ///  and <see cref="dataToReturn"/>.Count() rows.
        /// 
        /// The first row of <see cref="dataToReturn"/> will be examined to determine the DataType for each of the <see cref="propertyNames"/>.
        /// 
        /// The columns will be populated from the correspondingly-named properties of <see cref="dataToReturn"/>.
        /// 
        /// Property names such as "ComplexProperty.NestedPropertyValue" will return the corresponding 'nested' property of 
        /// each item in <see cref="dataToReturn"/>. 
        /// 
        /// The properties must be public instance properties and must be both readable and writeable.
        /// 
        /// The FakeDbCommands are (in the current version) queued and must be invoked in the order they were setup.
        /// </summary>
        /// <param name="dataToReturn">A scalar data item</param>
        /// <param name="propertyNames">An array of property names which will be used to (1) supply metadata for the returned result set
        /// and (2) identify properties on <see cref="dataToReturn"/> whose values will populate the result</param>
        /// <returns>Itself, for chaining</returns>
        /// <exception cref="TargetInvocationException">If the given <see cref="propertyNames"/> cannot be read by reflection from the elements of 
        /// <see cref="dataToReturn"/> then an exception will be thrown immediately.</exception>
=======
        /// Queue a command to the fake database connection which when invoked with
        /// ExecuteQuery will return a result set with rows containing the rows of dataToReturn.
        /// The returned rows will contain one column for each public property of the dataToReturn named in <param name="propertyNames"></param>
        /// Execution will fail if T does not have a public constructor with either no parameters or else 
        /// one correspondingly-named parameter for each public property listed.
        /// 
        /// Use this overload to setup database queries with columns which exactly correspond to some class defined in your project
        /// 
        /// Example
        /// <code>
        /// fakeDbConnection.SetUpForQuery&lt;MyEntity&gt;(new []{new MyEntity(1,"Entity 1")},new[]{"Id","Description");
        /// </code>
        /// will return a single row with columns named Id &amp; Description, containing the values {1, "Entity1"}.
        /// When used with Dapper, will simply rehydrate the given dataToReturn
        /// </summary>
        /// <param name="propertyNames">The columns returned will be just those public properties of typeof(dataToReturn) named in this list</param>
>>>>>>> 0a105a784a5b90c0c468ab057555278cab8427c3
        public static FakeDbConnection SetUpForQuery<T>(this FakeDbConnection fakeDbConnection, IEnumerable<T> dataToReturn, string[] propertyNames)
        {
            fakeDbConnection.QueueCommand( FakeDbCommand.ForExecuteQuery(dataToReturn,propertyNames) );
            return fakeDbConnection;
        }

        /// <summary>
<<<<<<< HEAD
        /// Sets up the Fake DbConnection to return a FakeDbCommand which is itself set up to return <see cref="dataToReturn"/> when 
        /// either the protected <see cref="DbCommand.ExecuteDbDataReader"/> or the public 
        /// <see cref="DbCommand.ExecuteReader()"/> is called on it.
        /// 
        /// This overload will return a result set with 1 column per string in <see cref="propertyNames"/> 
        ///  and <see cref="dataToReturn"/>.Count() rows.
        /// 
        /// The first row of <see cref="dataToReturn"/> will be examined with GetType() to determine the DataType for each column.
        /// (Nulls will result in a column of type object. To specify more exact metadata, use the overload that excepts 
        /// a <see cref="FakeDbResultSet.MetaData"/> array instead).
        /// 
        /// The columns will be populated left-to-right from elements of each row of <see cref="dataToReturn"/> and will be named 
        /// left-to-right from the given <see cref="propertyNames"/>.
        /// 
        /// Property names such as "ComplexProperty.NestedPropertyValue" should work. The properties must be public instance properties and
        /// must be both readable and writeable.
        /// 
        /// The FakeDbCommands are (in the current version) queued and must be invoked in the order they were setup.
        /// </summary>
        /// <param name="dataToReturn">A scalar data item</param>
        /// <param name="propertyNames">An array of property names which will be used to (1) supply metadata for the returned result set
        /// and (2) identify properties on <see cref="dataToReturn"/> whose values will populate the result</param>
        /// <returns>Itself, for chaining</returns>
        public static FakeDbConnection SetUpForQuery(this FakeDbConnection fakeDbConnection, IEnumerable<object[]> dataToReturn, params string[] propertyNames)
=======
        /// Queue a command to the fake database connection which when invoked with
        /// ExecuteQuery will return a result set with rows containing the rows of dataToReturn.
        /// The returned rows will contain as many columns as the given object[] arrays are long.
        /// The columns will be named from the left with the names given in <param name="columnNames"></param>. If not enough names are
        /// passed in, the remaining columns will be nameless.
        /// 
        /// Use this overload to setup database queries with columns which do not exactly correspond to some class defined in your project
        /// </summary>
        /// <param name="columnNames">The columns will be named from the left with the names given. If fewer names are passed in than
        /// there are columns in <paramref name="dataToReturn"/> then the remaining columns will be nameless.</param>
        /// <exception cref="InvalidOperationException">If dataToReturn is null, and no column names are given, then an exception will be thrown because 
        /// metadata cannot be inferred from no data and no hints.</exception>
        public static FakeDbConnection SetUpForQuery(this FakeDbConnection fakeDbConnection, IEnumerable<object[]> dataToReturn, params string[] columnNames)
>>>>>>> 0a105a784a5b90c0c468ab057555278cab8427c3
        {
            fakeDbConnection.QueueCommand(FakeDbCommand.ForExecuteQuery(dataToReturn, columnNames));
            return fakeDbConnection;
        }

        /// <summary>
<<<<<<< HEAD
        /// Sets up the FakeDbConnection to return a FakeDbCommand which is itself set up to return <see cref="dataToReturn"/> when 
        /// either the protected <see cref="DbCommand.ExecuteDbDataReader"/> or the public 
        /// <see cref="DbCommand.ExecuteReader()"/> is called on it.
        /// 
        /// This overload will return a result set with 1 column per element in <see cref="metaData"/> 
        /// (which should exactly match <see><cref>dataToReturn.Length</cref></see>)
        /// and <see cref="dataToReturn"/>.Count() rows.
        /// 
        /// The columns will be populated left-to-right from elements of each row of <see cref="dataToReturn"/> and will have 
        /// metadata (column name and .Net Type) assigned left-to-right from the given <see cref="metaData"/> array.
        /// 
        /// The FakeDbCommands are (in the current version) queued and must be invoked in the order they were setup.
        /// </summary>
        /// <param name="dataToReturn">A scalar data item</param>
        /// <param name="propertyNames">An array of property names which will be used to (1) supply metadata for the returned result set
        /// and (2) identify properties on <see cref="dataToReturn"/> whose values will populate the result</param>
        /// <returns>Itself, for chaining</returns>
=======
        /// Queue a command to the fake database connection which when invoked with
        /// ExecuteQuery will return a result set with rows containing the rows of dataToReturn.
        /// The returned data will have columns as per the given metaData.
        /// 
        /// Use this overload to setup database queries with columns which do not exactly correspond to some class defined in your project
        /// </summary>
        /// <param name="metaData">The returned result will have exactly the given metaData. If the width of <paramref name="dataToReturn"/>
        /// does not match the width of the metaDate, anonomous data will be returned. </param>
        /// <exception cref="InvalidOperationException">If dataToReturn is null, and no column names are given, then an exception will be thrown because 
        /// metadata cannot be inferred from no data and no hints.</exception>
>>>>>>> 0a105a784a5b90c0c468ab057555278cab8427c3
        public static FakeDbConnection SetUpForQuery(this FakeDbConnection fakeDbConnection, IEnumerable<object[]> dataToReturn, FakeDbResultSet.MetaData[] metaData)
        {
            fakeDbConnection.QueueCommand(FakeDbCommand.ForExecuteQuery(dataToReturn, metaData));
            return fakeDbConnection;
        }
    }
}